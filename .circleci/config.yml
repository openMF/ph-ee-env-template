version: 2.1

jobs:
  build:
    docker:
      - image: ubuntu:latest
    resource_class: large
    steps:
      - checkout
      - run: apt-get update && apt-get install -y curl
      - run: 
          name: Install Minikube
          command: |
            curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
            chmod +x minikube
            mv minikube /usr/local/bin/
      - run:
          name: Start Minikube
          command: |
            minikube start --memory 16384 --driver=docker
      - run:
          name: Install Helm
          command: |
            curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
      - run:
          name: Deploy Helm Charts
          command: |
            # sudo apt-get update
            # sudo apt-get install -y apt-transport-https ca-certificates curl gpg
            # sudo mkdir -p /etc/apt/keyrings
            # sudo touch -y /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            # curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            # echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
            # sudo apt-get update
            # kubectl version
            # curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
            # sudo apt-get install apt-transport-https --yes
            # echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
            
            #payment install
            kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/example/prometheus-operator-crd/monitoring.coreos.com_servicemonitors.yaml #Install ServiceMonitor
            kubectl create namespace paymenthub
            kubectl get -A namespace  
            helm repo add g2p-sandbox-1-3-1 https://fynarfin.io/images/ph-ee-g2psandbox-1.3.1/
            helm install ph-ee-g2psandbox g2p-sandbox-1-3-1/ph-ee-g2psandbox --version 1.3.1 -n paymenthub 
            
            kubectl get pods -n paymenthub
      - run:
          name: helm test
          command: |
            helm test ph-ee-g2psandbox -n paymenthub --timeout 5m


workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build

# version: 2.1
# setup: true

# orbs:
#   test-harness: govstack-working-group/testutils@1.0.6

# workflows:
#   test_everything:
#     jobs:
#       - test-harness/create-config:
#           post-steps: # Persist to workspace has to be defined in main workflow
#             - persist_to_workspace:
#                 root: workspace
#                 paths:
#                   - generated.yml
#       - test-harness/execute-tests:
#           requires:
#             - test-harness/create-config
